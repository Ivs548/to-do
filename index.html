<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>To-Do Planner+</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            /* Цвета категорий */
            --cat-event: #FFA500;     /* мероприятия - оранжевый */
            --cat-medical: #FF69B4;   /* медицина - розовый */
            --cat-household: #1E90FF; /* бытовые - голубой */
            --cat-products: #808080;  /* продукты - серый */
            --cat-shopping: #9370DB;  /* покупки - сиреневый */
            --cat-study: #FFD700;     /* учебные - желтый */
            --cat-hobby: #32CD32;     /* хобби - зеленый */
            
            --primary: #4a6fa5;
            --secondary: #6d9dc5;
            --light: #f8f9fa;
            --dark: #343a40;
            --success: #28a745;
            --warning: #ffc107;
            --danger: #dc3545;
            --border-radius: 12px;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            --transition: all 0.3s ease;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        
        body {
            background-color: #f5f7fa;
            color: var(--dark);
            line-height: 1.6;
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            -webkit-font-smoothing: antialiased;
        }
        
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #ddd;
        }
        
        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .logo h1 {
            color: var(--primary);
            font-size: 2rem;
        }
        
        .logo i {
            color: var(--primary);
            font-size: 2.2rem;
        }
        
        .main-container {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: 20px;
            flex: 1;
        }
        
        /* Стили для боковой панели с карточками - УМЕНЬШЕНЫ НА 40% */
        .sidebar {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }
        
        .card {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 8px 10px; /* Уменьшено на 40% */
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            border-left: 3px solid var(--primary);
            min-height: auto;
            user-select: none;
        }
        
        .card:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }
        
        .card-title {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 3px;
            font-size: 0.85rem; /* Уменьшен размер шрифта */
            font-weight: 600;
            color: var(--primary);
        }
        
        .card-content {
            color: #666;
            font-size: 0.7rem; /* Уменьшен размер шрифта */
        }
        
        .card.today {
            border-left-color: #ff6b6b;
        }
        
        .card.week {
            border-left-color: #4ecdc4;
        }
        
        .card.month {
            border-left-color: #45b7d1;
        }
        
        .card.year {
            border-left-color: #96ceb4;
        }
        
        /* Стили для кнопок категорий */
        .categories-container {
            margin-top: 15px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .categories-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--primary);
        }
        
        .category-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 12px;
        }
        
        .category-btn {
            display: flex;
            align-items: center;
            gap: 4px;
            padding: 5px 8px;
            border-radius: 14px;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
            font-size: 0.75rem;
            color: white;
            white-space: nowrap;
            user-select: none;
        }
        
        .category-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.15);
        }
        
        .category-btn.event {
            background-color: var(--cat-event);
        }
        
        .category-btn.medical {
            background-color: var(--cat-medical);
        }
        
        .category-btn.household {
            background-color: var(--cat-household);
        }
        
        .category-btn.products {
            background-color: var(--cat-products);
        }
        
        .category-btn.shopping {
            background-color: var(--cat-shopping);
        }
        
        .category-btn.study {
            background-color: var(--cat-study);
            color: #333;
        }
        
        .category-btn.hobby {
            background-color: var(--cat-hobby);
        }
        
        .category-btn i {
            font-size: 0.7rem;
        }
        
        /* Стили для основного контента */
        .content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow);
            min-height: 600px;
            overflow-y: auto;
            max-height: 70vh;
            display: flex;
            flex-direction: column;
            -webkit-overflow-scrolling: touch;
        }
        
        .content-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            flex-shrink: 0;
        }
        
        .content-title {
            font-size: 1.5rem;
            color: var(--primary);
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 1.3rem;
            cursor: pointer;
            color: #888;
            transition: var(--transition);
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .close-btn:hover {
            color: var(--primary);
        }
        
        /* Стили для редактируемого списка в стиле "Заметок" */
        .notes-style-list {
            display: flex;
            flex-direction: column;
            gap: 6px;
            flex: 1;
            overflow-y: auto;
        }
        
        .task-item-editable {
            display: flex;
            align-items: center;
            padding: 6px 10px;
            border-radius: 6px;
            background-color: #f9f9f9;
            min-height: 36px;
            transition: var(--transition);
            position: relative;
        }
        
        .task-checkbox-editable {
            margin-right: 10px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        .task-content-editable {
            flex: 1;
            width: 100%;
            display: flex;
            align-items: center;
        }
        
        .task-input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 0.95rem;
            padding: 2px 0;
            outline: none;
            font-family: inherit;
            resize: none;
            min-height: 22px;
            line-height: 1.4;
            -webkit-appearance: none;
            border-radius: 0;
        }
        
        .task-input:focus {
            border-bottom: 1px solid #ddd;
        }
        
        .task-input.completed {
            text-decoration: line-through;
            color: #888;
        }
        
        /* Поле для добавления задачи как в текстовом редакторе */
        .add-task-input {
            width: 100%;
            border: none;
            background: transparent;
            font-size: 0.95rem;
            padding: 8px 0;
            outline: none;
            font-family: inherit;
            color: #666;
            display: none;
            -webkit-appearance: none;
            border-radius: 0;
        }
        
        .add-task-input::placeholder {
            color: #aaa;
        }
        
        /* Ярлыки категорий */
        .category-badge {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
            vertical-align: middle;
            flex-shrink: 0;
        }
        
        /* Стили для сворачиваемых карточек категорий */
        .collapsible-card {
            background-color: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 10px;
            overflow: hidden;
            border: 1px solid #eee;
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 12px;
            cursor: pointer;
            background-color: #f8f9fa;
            transition: var(--transition);
        }
        
        .card-header:hover {
            background-color: #f0f0f0;
        }
        
        .card-header-title {
            display: flex;
            align-items: center;
            gap: 6px;
            font-weight: 600;
            font-size: 0.95rem;
        }
        
        .card-header i {
            transition: var(--transition);
            font-size: 0.9rem;
        }
        
        .card-header.collapsed i {
            transform: rotate(-90deg);
        }
        
        .card-content-collapsible {
            padding: 0 12px;
            max-height: 500px;
            overflow: hidden;
            transition: var(--transition);
        }
        
        .card-content-collapsible.collapsed {
            max-height: 0;
            padding: 0 12px;
        }
        
        /* Кнопки резервного копирования внизу основного контента */
        .backup-section {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 15px;
            border-top: 1px solid #eee;
            flex-shrink: 0;
        }
        
        .backup-btn {
            padding: 8px 12px;
            background-color: #6c757d;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: var(--transition);
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            flex: 1;
            user-select: none;
            -webkit-appearance: none;
        }
        
        .backup-btn:hover {
            background-color: #5a6268;
        }
        
        .backup-btn.export {
            background-color: var(--success);
        }
        
        .backup-btn.export:hover {
            background-color: #218838;
        }
        
        /* Стили для недельного представления */
        .week-view {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 10px;
        }
        
        .day-card-week {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 10px;
            box-shadow: var(--shadow);
            border-top: 3px solid var(--secondary);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .day-card-week:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        .day-header-week {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
            padding-bottom: 4px;
            border-bottom: 1px solid #eee;
        }
        
        .day-name-week {
            font-weight: 600;
            color: var(--primary);
            font-size: 0.85rem;
        }
        
        .day-date-week {
            color: #888;
            font-size: 0.75rem;
        }
        
        .category-summary-week {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin-top: 6px;
        }
        
        .category-item-week {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .category-color-week {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            margin-right: 5px;
        }
        
        .category-name-week {
            flex: 1;
            font-size: 0.75rem;
        }
        
        .category-count-week {
            background-color: #eee;
            padding: 1px 5px;
            border-radius: 8px;
            font-size: 0.7rem;
        }
        
        /* Стили для месячного календаря */
        .calendar {
            width: 100%;
        }
        
        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 12px;
        }
        
        .calendar-nav {
            display: flex;
            gap: 6px;
        }
        
        .calendar-nav button {
            padding: 6px 10px;
            border: none;
            background-color: var(--primary);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.8rem;
            user-select: none;
            -webkit-appearance: none;
        }
        
        .calendar-nav button:hover {
            background-color: var(--secondary);
        }
        
        .calendar-month {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--dark);
        }
        
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 3px;
        }
        
        .calendar-day-name {
            text-align: center;
            padding: 6px;
            font-weight: 600;
            color: var(--primary);
            font-size: 0.85rem;
        }
        
        .calendar-day {
            height: 65px;
            padding: 5px;
            border-radius: 6px;
            background-color: #f8f9fa;
            border: 1px solid #eee;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }
        
        .calendar-day:hover {
            background-color: #e9ecef;
        }
        
        .calendar-day.has-tasks {
            background-color: rgba(255, 245, 200, 0.5);
        }
        
        .day-number {
            font-weight: 600;
            margin-bottom: 3px;
            font-size: 0.8rem;
        }
        
        .day-tasks {
            display: flex;
            flex-wrap: wrap;
            gap: 2px;
            margin-top: 3px;
        }
        
        .task-dot {
            width: 7px;
            height: 7px;
            border-radius: 50%;
        }
        
        /* Стили для годового представления */
        .year-view {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 12px;
        }
        
        .month-card-year {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 12px;
            box-shadow: var(--shadow);
            cursor: pointer;
            transition: var(--transition);
            border-top: 3px solid var(--primary);
        }
        
        .month-card-year:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.1);
        }
        
        .month-name-year {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 6px;
        }
        
        .month-stats-year {
            display: flex;
            justify-content: space-between;
            font-size: 0.8rem;
            color: #666;
        }
        
        /* Стили для кнопки добавления задачи */
        .add-task-btn {
            position: fixed;
            bottom: 25px;
            right: 25px;
            width: 55px;
            height: 55px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            border: none;
            font-size: 1.6rem;
            cursor: pointer;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            transition: var(--transition);
            z-index: 100;
            -webkit-appearance: none;
        }
        
        .add-task-btn:hover {
            background-color: var(--secondary);
            transform: scale(1.08);
        }
        
        /* Стили для модальных окон */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            border-radius: var(--border-radius);
            padding: 20px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .modal-title {
            font-size: 1.2rem;
            color: var(--primary);
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #888;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            -webkit-appearance: none;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .form-group input, 
        .form-group select, 
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 0.95rem;
            -webkit-appearance: none;
        }
        
        .form-group textarea {
            min-height: 80px;
            resize: vertical;
        }
        
        /* Особые стили для input type="date" в Safari */
        input[type="date"] {
            position: relative;
        }
        
        input[type="date"]::-webkit-calendar-picker-indicator {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            width: auto;
            height: auto;
            color: transparent;
            background: transparent;
        }
        
        input[type="date"]::-webkit-inner-spin-button,
        input[type="date"]::-webkit-clear-button {
            display: none;
        }
        
        /* Стили для повторяющихся задач */
        .recurrence-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 10px;
        }
        
        .recurrence-option {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            font-size: 0.85rem;
            user-select: none;
        }
        
        .recurrence-option:hover {
            background-color: #f0f0f0;
        }
        
        .recurrence-option.selected {
            background-color: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            font-size: 0.95rem;
            -webkit-appearance: none;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--secondary);
        }
        
        .btn-secondary {
            background-color: #6c757d;
            color: white;
        }
        
        .btn-secondary:hover {
            background-color: #5a6268;
        }
        
        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* Стиль для пустого состояния */
        .empty-state {
            text-align: center;
            padding: 25px 15px;
            color: #888;
        }
        
        .empty-state i {
            font-size: 2.2rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }
        
        .empty-state p {
            font-size: 0.9rem;
        }
        
        /* Адаптивность */
        @media (max-width: 1100px) {
            .main-container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                display: grid;
                grid-template-columns: repeat(2, 1fr);
            }
            
            .category-buttons {
                justify-content: center;
            }
            
            .week-view {
                grid-template-columns: repeat(4, 1fr);
            }
            
            .year-view {
                grid-template-columns: repeat(3, 1fr);
            }
        }
        
        @media (max-width: 768px) {
            .week-view {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .year-view {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .category-buttons {
                justify-content: flex-start;
            }
            
            .calendar-grid {
                grid-template-columns: repeat(7, 1fr);
                font-size: 0.8rem;
            }
            
            .calendar-day {
                height: 55px;
                padding: 4px;
            }
            
            .sidebar {
                grid-template-columns: 1fr;
            }
            
            .backup-section {
                flex-direction: column;
            }
        }
        
        @media (max-width: 576px) {
            .week-view, .year-view {
                grid-template-columns: 1fr;
            }
            
            .category-buttons {
                flex-wrap: wrap;
                justify-content: center;
            }
            
            .category-btn {
                padding: 4px 6px;
                font-size: 0.7rem;
            }
            
            body {
                padding: 10px;
            }
            
            .content {
                padding: 15px;
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">
            <i class="fas fa-tasks"></i>
            <h1>To-Do Planner+</h1>
        </div>
    </header>
    
    <div class="main-container">
        <!-- Боковая панель с карточками -->
        <div class="sidebar">
            <div class="card today" id="today-card">
                <div class="card-title">
                    <span>Сегодня</span>
                    <i class="fas fa-sun"></i>
                </div>
                <div class="card-content" id="today-tasks-count">Загрузка...</div>
            </div>
            
            <div class="card week" id="week-card">
                <div class="card-title">
                    <span>Неделя</span>
                    <i class="fas fa-calendar-week"></i>
                </div>
                <div class="card-content">Просмотр дел на 7 дней</div>
            </div>
            
            <div class="card month" id="month-card">
                <div class="card-title">
                    <span>Месяц</span>
                    <i class="fas fa-calendar-alt"></i>
                </div>
                <div class="card-content">Календарь на текущий месяц</div>
            </div>
            
            <div class="card year" id="year-card">
                <div class="card-title">
                    <span>Год</span>
                    <i class="fas fa-calendar"></i>
                </div>
                <div class="card-content">Обзор на год</div>
            </div>
            
            <!-- Кнопки категорий -->
            <div class="categories-container">
                <div class="categories-title">Категории дел</div>
                <div class="category-buttons">
                    <button class="category-btn event" id="category-event">
                        <i class="fas fa-calendar-check"></i>
                        <span>Мероприятия</span>
                    </button>
                    <button class="category-btn medical" id="category-medical">
                        <i class="fas fa-heartbeat"></i>
                        <span>Медицина</span>
                    </button>
                    <button class="category-btn household" id="category-household">
                        <i class="fas fa-home"></i>
                        <span>Бытовые</span>
                    </button>
                    <button class="category-btn products" id="category-products">
                        <i class="fas fa-shopping-basket"></i>
                        <span>Продукты</span>
                    </button>
                    <button class="category-btn shopping" id="category-shopping">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Покупки</span>
                    </button>
                    <button class="category-btn study" id="category-study">
                        <i class="fas fa-graduation-cap"></i>
                        <span>Учебные</span>
                    </button>
                    <button class="category-btn hobby" id="category-hobby">
                        <i class="fas fa-palette"></i>
                        <span>Хобби</span>
                    </button>
                </div>
            </div>
        </div>
        
        <!-- Основная область контента с кнопками резервного копирования внизу -->
        <div class="content">
            <div class="content-header">
                <div class="content-title" id="content-title">Сегодня</div>
                <button class="close-btn" id="close-category-view" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="content-area">
                <!-- Здесь будет отображаться контент -->
            </div>
            
            <!-- Кнопки резервного копирования внизу основного контента -->
            <div class="backup-section">
                <button class="backup-btn export" id="export-backup">
                    <i class="fas fa-download"></i> Экспорт данных
                </button>
                <button class="backup-btn" id="import-backup">
                    <i class="fas fa-upload"></i> Импорт данных
                </button>
            </div>
        </div>
    </div>
    
    <!-- Кнопка добавления новой задачи -->
    <button class="add-task-btn" id="add-task-btn">
        <i class="fas fa-plus"></i>
    </button>
    
    <!-- Модальное окно для добавления/редактирования задачи -->
    <div class="modal" id="task-modal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title" id="modal-title">Новая задача</div>
                <button class="close-modal" id="close-modal">&times;</button>
            </div>
            <form id="task-form">
                <div class="form-group">
                    <label for="task-title">Название задачи</label>
                    <input type="text" id="task-title" required>
                </div>
                
                <div class="form-group">
                    <label for="task-description">Описание (необязательно)</label>
                    <textarea id="task-description"></textarea>
                </div>
                
                <div class="form-group">
                    <label for="task-category">Категория</label>
                    <select id="task-category" required>
                        <option value="event">Мероприятия</option>
                        <option value="medical">Медицина</option>
                        <option value="household">Бытовые</option>
                        <option value="products">Продукты</option>
                        <option value="shopping">Покупки</option>
                        <option value="study">Учебные</option>
                        <option value="hobby">Хобби</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="task-date">Дата выполнения</label>
                    <input type="date" id="task-date" required>
                </div>
                
                <div class="form-group">
                    <label>Повторение задачи</label>
                    <div class="recurrence-options" id="recurrence-options">
                        <div class="recurrence-option" data-value="none">Не повторять</div>
                        <div class="recurrence-option" data-value="daily">Ежедневно</div>
                        <div class="recurrence-option" data-value="weekly">Еженедельно</div>
                        <div class="recurrence-option" data-value="monthly">Ежемесячно</div>
                        <div class="recurrence-option" data-value="custom">Особое</div>
                    </div>
                    
                    <div id="custom-recurrence" style="display: none; margin-top: 15px;">
                        <div class="form-group">
                            <label for="recurrence-interval">Повторять каждые</label>
                            <div style="display: flex; align-items: center; gap: 10px;">
                                <input type="number" id="recurrence-interval" min="1" max="365" value="1" style="width: 80px;">
                                <select id="recurrence-unit">
                                    <option value="days">дней</option>
                                    <option value="weeks">недель</option>
                                    <option value="months">месяцев</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" id="cancel-task">Отмена</button>
                    <button type="submit" class="btn btn-primary" id="save-task">Сохранить</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Скрытый input для импорта файлов -->
    <input type="file" id="import-file-input" accept=".json" style="display: none;">

    <script>
        // Приложение To-Do Planner+
        document.addEventListener('DOMContentLoaded', function() {
            // Элементы DOM
            const todayCard = document.getElementById('today-card');
            const weekCard = document.getElementById('week-card');
            const monthCard = document.getElementById('month-card');
            const yearCard = document.getElementById('year-card');
            const contentTitle = document.getElementById('content-title');
            const contentArea = document.getElementById('content-area');
            const addTaskBtn = document.getElementById('add-task-btn');
            const taskModal = document.getElementById('task-modal');
            const closeModal = document.getElementById('close-modal');
            const cancelTaskBtn = document.getElementById('cancel-task');
            const taskForm = document.getElementById('task-form');
            const todayTasksCount = document.getElementById('today-tasks-count');
            const closeCategoryViewBtn = document.getElementById('close-category-view');
            const exportBackupBtn = document.getElementById('export-backup');
            const importBackupBtn = document.getElementById('import-backup');
            const importFileInput = document.getElementById('import-file-input');
            
            // Кнопки категорий
            const categoryButtons = {
                event: document.getElementById('category-event'),
                medical: document.getElementById('category-medical'),
                household: document.getElementById('category-household'),
                products: document.getElementById('category-products'),
                shopping: document.getElementById('category-shopping'),
                study: document.getElementById('category-study'),
                hobby: document.getElementById('category-hobby')
            };
            
            // Текущая дата и состояние приложения
            let currentView = 'today';
            let currentDate = new Date();
            let editingTaskId = null;
            let selectedRecurrence = 'none';
            let currentCategory = null;
            let lastFocusedInput = null;
            
            // Какие категории являются сворачиваемыми (ВСЕ КРОМЕ мероприятий и медицины)
            const collapsibleCategories = ['household', 'products', 'shopping', 'study', 'hobby'];
            
            // Инициализация приложения
            function initApp() {
                showTodayView();
                
                // Обработчики событий для карточек - с использованием click вместо touch
                todayCard.addEventListener('click', function(e) {
                    e.preventDefault();
                    showTodayView();
                });
                
                weekCard.addEventListener('click', function(e) {
                    e.preventDefault();
                    showWeekView();
                });
                
                monthCard.addEventListener('click', function(e) {
                    e.preventDefault();
                    showMonthView();
                });
                
                yearCard.addEventListener('click', function(e) {
                    e.preventDefault();
                    showYearView();
                });
                
                // Обработчики для модального окна
                addTaskBtn.addEventListener('click', openAddTaskModal);
                closeModal.addEventListener('click', closeTaskModal);
                cancelTaskBtn.addEventListener('click', closeTaskModal);
                
                // Обработчик отправки формы задачи
                taskForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    saveTask();
                });
                
                // Обработчики для повторяющихся задач
                document.querySelectorAll('.recurrence-option').forEach(option => {
                    option.addEventListener('click', function() {
                        document.querySelectorAll('.recurrence-option').forEach(opt => opt.classList.remove('selected'));
                        this.classList.add('selected');
                        selectedRecurrence = this.getAttribute('data-value');
                        
                        const customRecurrenceDiv = document.getElementById('custom-recurrence');
                        if (selectedRecurrence === 'custom') {
                            customRecurrenceDiv.style.display = 'block';
                        } else {
                            customRecurrenceDiv.style.display = 'none';
                        }
                    });
                });
                
                // Инициализация выбора "не повторять"
                document.querySelector('.recurrence-option[data-value="none"]').classList.add('selected');
                
                // Установка минимальной даты в поле выбора даты
                const today = new Date();
                const formattedDate = today.toISOString().split('T')[0];
                document.getElementById('task-date').min = formattedDate;
                document.getElementById('task-date').value = formattedDate;
                
                // Обработчики для кнопок категорий
                Object.keys(categoryButtons).forEach(category => {
                    categoryButtons[category].addEventListener('click', function(e) {
                        e.preventDefault();
                        showCategoryView(category);
                    });
                });
                
                // Обработчик для кнопки закрытия категории
                closeCategoryViewBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    showTodayView();
                    this.style.display = 'none';
                });
                
                // Обработчики для резервного копирования
                exportBackupBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    exportBackup();
                });
                
                importBackupBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    importFileInput.click();
                });
                
                importFileInput.addEventListener('change', importBackup);
                
                // Запуск автоматического переноса невыполненных задач
                setInterval(checkAndMoveUncompletedTasks, 60000);
                
                // Первоначальная проверка невыполненных задач
                checkAndMoveUncompletedTasks();
                
                // Добавляем обработчик для кликов вне модального окна
                window.addEventListener('click', function(e) {
                    if (e.target === taskModal) {
                        closeTaskModal();
                    }
                });
            }
            
            // Загрузка задач из localStorage
            function loadTasks() {
                const tasksJSON = localStorage.getItem('todoPlannerTasks');
                if (tasksJSON) {
                    return JSON.parse(tasksJSON);
                }
                return [];
            }
            
            // Сохранение задач в localStorage
            function saveTasks(tasks) {
                localStorage.setItem('todoPlannerTasks', JSON.stringify(tasks));
            }
            
            // Получение информации о категории
            function getCategoryInfo(category) {
                const categories = {
                    'event': { 
                        name: 'Мероприятия', 
                        color: '#FFA500',
                        icon: 'fas fa-calendar-check',
                        priority: true,
                        collapsible: false // Не сворачиваемая
                    },
                    'medical': { 
                        name: 'Медицина', 
                        color: '#FF69B4',
                        icon: 'fas fa-heartbeat',
                        priority: true,
                        collapsible: false // Не сворачиваемая
                    },
                    'household': { 
                        name: 'Бытовые', 
                        color: '#1E90FF',
                        icon: 'fas fa-home',
                        priority: false,
                        collapsible: true // Сворачиваемая
                    },
                    'products': { 
                        name: 'Продукты', 
                        color: '#808080',
                        icon: 'fas fa-shopping-basket',
                        priority: false,
                        collapsible: true // Сворачиваемая
                    },
                    'shopping': { 
                        name: 'Покупки', 
                        color: '#9370DB',
                        icon: 'fas fa-shopping-cart',
                        priority: false,
                        collapsible: true // Сворачиваемая
                    },
                    'study': { 
                        name: 'Учебные', 
                        color: '#FFD700',
                        icon: 'fas fa-graduation-cap',
                        priority: false,
                        collapsible: true // Сворачиваемая
                    },
                    'hobby': { 
                        name: 'Хобби', 
                        color: '#32CD32',
                        icon: 'fas fa-palette',
                        priority: false,
                        collapsible: true // Сворачиваемая
                    }
                };
                
                return categories[category] || { name: 'Без категории', color: '#ccc', icon: 'fas fa-tasks', priority: false, collapsible: false };
            }
            
            // Форматирование даты
            function formatDate(date) {
                const d = new Date(date);
                return d.toLocaleDateString('ru-RU', { day: '2-digit', month: '2-digit', year: 'numeric' });
            }
            
            // Форматирование даты для отображения заголовка
            function formatDateForTitle(date) {
                const d = new Date(date);
                const options = { weekday: 'long', day: 'numeric', month: 'long' };
                return d.toLocaleDateString('ru-RU', options);
            }
            
            // Показать представление "Сегодня"
            function showTodayView() {
                currentView = 'today';
                currentCategory = null;
                const today = new Date();
                contentTitle.textContent = formatDateForTitle(today);
                closeCategoryViewBtn.style.display = 'none';
                contentArea.innerHTML = '';
                
                const tasks = loadTasks();
                const todayTasks = tasks.filter(task => {
                    const taskDate = new Date(task.date).toDateString();
                    return taskDate === today.toDateString() && !task.deleted;
                });
                
                // Обновление счетчика задач на карточке "Сегодня"
                const activeTasks = todayTasks.filter(task => !task.completed).length;
                todayTasksCount.textContent = `${activeTasks} активных ${getNoun(activeTasks, 'задача', 'задачи', 'задач')}`;
                
                if (todayTasks.length === 0) {
                    contentArea.innerHTML = `
                        <div class="empty-state">
                            <i class="fas fa-clipboard-check"></i>
                            <p>Нет задач на сегодня.</p>
                            <p style="margin-top: 10px;">Начните вводить текст ниже и нажмите Enter</p>
                        </div>
                    `;
                    
                    // Добавление поля для новой задачи в пустом состоянии
                    createAddTaskInput(null, 'household');
                    return;
                }
                
                // Группировка задач по категориям
                const tasksByCategory = {};
                todayTasks.forEach(task => {
                    if (!tasksByCategory[task.category]) {
                        tasksByCategory[task.category] = [];
                    }
                    tasksByCategory[task.category].push(task);
                });
                
                // Определение порядка отображения категорий
                const categoryOrder = ['event', 'medical', 'household', 'study', 'hobby', 'products', 'shopping'];
                
                // Создаем контейнер для всех задач
                const allTasksContainer = document.createElement('div');
                allTasksContainer.className = 'notes-style-list';
                
                // Добавляем задачи из каждой категории
                categoryOrder.forEach(category => {
                    if (tasksByCategory[category] && tasksByCategory[category].length > 0) {
                        const categoryInfo = getCategoryInfo(category);
                        
                        // Для сворачиваемых категорий создаем карточки
                        if (categoryInfo.collapsible) {
                            const cardTasks = tasksByCategory[category];
                            const cardElement = createCollapsibleCategoryCard(category, cardTasks);
                            allTasksContainer.appendChild(cardElement);
                        } else {
                            // Для не сворачиваемых категорий (мероприятия и медицина) добавляем задачи напрямую
                            const categoryTasks = tasksByCategory[category];
                            
                            // Для приоритетных категорий можно добавить заголовок
                            if (categoryInfo.priority) {
                                const priorityHeader = document.createElement('div');
                                priorityHeader.className = 'card-header';
                                priorityHeader.style.cursor = 'default';
                                priorityHeader.style.marginBottom = '5px';
                                priorityHeader.style.backgroundColor = 'transparent';
                                priorityHeader.style.padding = '5px 0';
                                priorityHeader.innerHTML = `
                                    <div class="card-header-title">
                                        <i class="${categoryInfo.icon}"></i>
                                        <span>${categoryInfo.name} (${categoryTasks.length})</span>
                                    </div>
                                `;
                                allTasksContainer.appendChild(priorityHeader);
                            }
                            
                            // Добавляем задачи
                            categoryTasks.forEach(task => {
                                const taskElement = createEditableTaskElement(task);
                                allTasksContainer.appendChild(taskElement);
                            });
                        }
                    }
                });
                
                contentArea.appendChild(allTasksContainer);
                
                // Добавляем поле для ввода в конце списка
                createAddTaskInput(null, 'household');
            }
            
            // Создание поля для добавления задачи
            function createAddTaskInput(afterElement = null, defaultCategory = 'household') {
                const addTaskInput = document.createElement('input');
                addTaskInput.type = 'text';
                addTaskInput.className = 'add-task-input';
                addTaskInput.placeholder = 'Нажмите Enter для добавления задачи...';
                
                // Отображаем поле
                addTaskInput.style.display = 'block';
                
                // Вставляем поле в нужное место
                const taskList = contentArea.querySelector('.notes-style-list');
                if (taskList) {
                    if (afterElement && afterElement.parentNode) {
                        afterElement.parentNode.insertBefore(addTaskInput, afterElement.nextSibling);
                    } else {
                        taskList.appendChild(addTaskInput);
                    }
                } else {
                    contentArea.appendChild(addTaskInput);
                }
                
                // Фокусируемся на поле ввода
                setTimeout(() => {
                    addTaskInput.focus();
                }, 10);
                
                // Обработчик для добавления задачи
                addTaskInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && this.value.trim()) {
                        e.preventDefault();
                        
                        // Определяем категорию для новой задачи
                        let category = defaultCategory;
                        
                        // Если есть последний сфокусированный элемент, берем категорию из него
                        if (lastFocusedInput) {
                            const taskElement = lastFocusedInput.closest('.task-item-editable');
                            if (taskElement) {
                                const taskId = taskElement.dataset.id;
                                const tasks = loadTasks();
                                const task = tasks.find(t => t.id === taskId);
                                if (task) {
                                    category = task.category;
                                }
                            }
                        }
                        
                        // Добавляем задачу
                        const newTask = {
                            id: Date.now().toString(),
                            title: this.value.trim(),
                            category: category,
                            date: new Date().toISOString(),
                            completed: false,
                            deleted: false,
                            createdAt: new Date().toISOString()
                        };
                        
                        const tasks = loadTasks();
                        tasks.push(newTask);
                        saveTasks(tasks);
                        
                        // Обновляем отображение
                        if (currentView === 'today') {
                            showTodayView();
                        } else if (currentView === 'category') {
                            showCategoryView(currentCategory);
                        }
                    }
                });
                
                // Сохраняем ссылку на поле ввода
                addTaskInput.addEventListener('focus', function() {
                    lastFocusedInput = this;
                });
                
                return addTaskInput;
            }
            
            // Создание сворачиваемой карточки для категории
            function createCollapsibleCategoryCard(category, tasks) {
                const categoryInfo = getCategoryInfo(category);
                const cardId = `card-${category}`;
                
                const card = document.createElement('div');
                card.className = 'collapsible-card';
                card.id = cardId;
                
                // По умолчанию сворачиваемые карточки развернуты
                const isCollapsed = localStorage.getItem(`card-${category}-collapsed`) === 'true';
                
                card.innerHTML = `
                    <div class="card-header ${isCollapsed ? 'collapsed' : ''}" data-card="${cardId}">
                        <div class="card-header-title">
                            <i class="${categoryInfo.icon}"></i>
                            <span>${categoryInfo.name} (${tasks.length})</span>
                        </div>
                        <div>
                            <i class="fas fa-chevron-down"></i>
                        </div>
                    </div>
                    <div class="card-content-collapsible ${isCollapsed ? 'collapsed' : ''}">
                        <div class="notes-style-list" style="padding: 6px 0;">
                            <!-- Задачи будут добавлены здесь -->
                        </div>
                    </div>
                `;
                
                // Добавление задач в карточку
                const taskList = card.querySelector('.notes-style-list');
                
                // Сортировка задач
                tasks.sort((a, b) => {
                    if (a.completed && !b.completed) return 1;
                    if (!a.completed && b.completed) return -1;
                    return 0;
                });
                
                tasks.forEach(task => {
                    const taskElement = createEditableTaskElement(task);
                    taskList.appendChild(taskElement);
                });
                
                // Обработчик для сворачивания/разворачивания карточки
                const cardHeader = card.querySelector('.card-header');
                cardHeader.addEventListener('click', function(e) {
                    e.preventDefault();
                    const card = document.getElementById(this.dataset.card);
                    const content = card.querySelector('.card-content-collapsible');
                    const icon = this.querySelector('.fa-chevron-down');
                    
                    if (content.classList.contains('collapsed')) {
                        content.classList.remove('collapsed');
                        this.classList.remove('collapsed');
                        icon.style.transform = 'rotate(0deg)';
                        localStorage.setItem(`card-${category}-collapsed`, 'false');
                    } else {
                        content.classList.add('collapsed');
                        this.classList.add('collapsed');
                        icon.style.transform = 'rotate(-90deg)';
                        localStorage.setItem(`card-${category}-collapsed`, 'true');
                    }
                });
                
                return card;
            }
            
            // Создание редактируемого элемента задачи
            function createEditableTaskElement(task) {
                const taskElement = document.createElement('div');
                taskElement.className = 'task-item-editable';
                taskElement.dataset.id = task.id;
                
                const categoryInfo = getCategoryInfo(task.category);
                
                taskElement.innerHTML = `
                    <input type="checkbox" class="task-checkbox-editable" ${task.completed ? 'checked' : ''}>
                    <span class="category-badge" style="background-color: ${categoryInfo.color}"></span>
                    <div class="task-content-editable">
                        <input type="text" class="task-input ${task.completed ? 'completed' : ''}" 
                               value="${task.title}" data-original="${task.title}" ${task.completed ? 'disabled' : ''}>
                    </div>
                `;
                
                // Обработчик для чекбокса
                const checkbox = taskElement.querySelector('.task-checkbox-editable');
                checkbox.addEventListener('change', function() {
                    const taskInput = taskElement.querySelector('.task-input');
                    
                    if (this.checked) {
                        taskInput.classList.add('completed');
                        taskInput.disabled = true;
                    } else {
                        taskInput.classList.remove('completed');
                        taskInput.disabled = false;
                    }
                    
                    updateTaskCompletion(task.id, this.checked, taskInput.value);
                });
                
                // Обработчик для редактирования текста задачи
                const taskInput = taskElement.querySelector('.task-input');
                taskInput.addEventListener('focus', function() {
                    lastFocusedInput = this;
                });
                
                taskInput.addEventListener('blur', function() {
                    if (this.value !== this.dataset.original) {
                        updateTaskTitle(task.id, this.value);
                        this.dataset.original = this.value;
                    }
                });
                
                // Обработчик для добавления новой задачи после текущей
                taskInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !task.completed) {
                        e.preventDefault();
                        this.blur();
                        
                        // Создаем новое поле для ввода после текущей задачи
                        createAddTaskInput(taskElement, task.category);
                    }
                });
                
                return taskElement;
            }
            
            // Обновление статуса выполнения задачи
            function updateTaskCompletion(taskId, completed, title) {
                const tasks = loadTasks();
                const taskIndex = tasks.findIndex(t => t.id === taskId);
                
                if (taskIndex !== -1) {
                    tasks[taskIndex].completed = completed;
                    tasks[taskIndex].completedDate = completed ? new Date().toISOString() : null;
                    tasks[taskIndex].title = title || tasks[taskIndex].title;
                    saveTasks(tasks);
                    
                    // Обновление счетчика задач
                    const today = new Date().toDateString();
                    const todayTasks = tasks.filter(task => {
                        const taskDate = new Date(task.date).toDateString();
                        return taskDate === today && !task.deleted;
                    });
                    
                    const activeTasks = todayTasks.filter(task => !task.completed).length;
                    todayTasksCount.textContent = `${activeTasks} активных ${getNoun(activeTasks, 'задача', 'задачи', 'задач')}`;
                }
            }
            
            // Обновление названия задачи
            function updateTaskTitle(taskId, title) {
                const tasks = loadTasks();
                const taskIndex = tasks.findIndex(t => t.id === taskId);
                
                if (taskIndex !== -1 && title.trim()) {
                    tasks[taskIndex].title = title.trim();
                    saveTasks(tasks);
                }
            }
            
            // Показать представление категории
            function showCategoryView(category) {
                currentView = 'category';
                currentCategory = category;
                const categoryInfo = getCategoryInfo(category);
                
                contentTitle.textContent = categoryInfo.name;
                closeCategoryViewBtn.style.display = 'block';
                contentArea.innerHTML = '';
                
                const today = new Date().toDateString();
                const tasks = loadTasks();
                
                // Фильтрация задач: только текущей категории и на сегодня
                const categoryTasks = tasks.filter(task => {
                    const taskDate = new Date(task.date).toDateString();
                    return task.category === category && taskDate === today && !task.deleted;
                });
                
                const taskList = document.createElement('div');
                taskList.className = 'notes-style-list';
                
                if (categoryTasks.length === 0) {
                    taskList.innerHTML = `
                        <div class="empty-state" style="padding: 15px 0;">
                            <p>Нет задач в категории "${categoryInfo.name}" на сегодня.</p>
                        </div>
                    `;
                } else {
                    // Сортировка задач: сначала невыполненные, затем выполненные
                    categoryTasks.sort((a, b) => {
                        if (a.completed && !b.completed) return 1;
                        if (!a.completed && b.completed) return -1;
                        return 0;
                    });
                    
                    categoryTasks.forEach(task => {
                        const taskElement = createEditableTaskElement(task);
                        taskList.appendChild(taskElement);
                    });
                }
                
                contentArea.appendChild(taskList);
                
                // Добавляем поле для ввода в конце списка
                createAddTaskInput(null, category);
            }
            
            // Склонение существительных
            function getNoun(number, one, two, five) {
                let n = Math.abs(number);
                n %= 100;
                if (n >= 5 && n <= 20) {
                    return five;
                }
                n %= 10;
                if (n === 1) {
                    return one;
                }
                if (n >= 2 && n <= 4) {
                    return two;
                }
                return five;
            }
            
            // Показать представление "Неделя"
            function showWeekView() {
                currentView = 'week';
                currentCategory = null;
                contentTitle.textContent = 'Неделя';
                closeCategoryViewBtn.style.display = 'none';
                contentArea.innerHTML = '';
                
                const weekView = document.createElement('div');
                weekView.className = 'week-view';
                
                const today = new Date();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - today.getDay() + 1);
                
                const tasks = loadTasks();
                
                for (let i = 0; i < 7; i++) {
                    const day = new Date(startOfWeek);
                    day.setDate(startOfWeek.getDate() + i);
                    
                    const dayCard = document.createElement('div');
                    dayCard.className = 'day-card-week';
                    
                    const dayTasks = tasks.filter(task => {
                        const taskDate = new Date(task.date).toDateString();
                        return taskDate === day.toDateString() && !task.deleted;
                    });
                    
                    // Группировка задач по категориям
                    const categories = {};
                    dayTasks.forEach(task => {
                        if (!categories[task.category]) {
                            categories[task.category] = 0;
                        }
                        categories[task.category]++;
                    });
                    
                    dayCard.innerHTML = `
                        <div class="day-header-week">
                            <div class="day-name-week">${day.toLocaleDateString('ru-RU', { weekday: 'short' })}</div>
                            <div class="day-date-week">${day.getDate()} ${day.toLocaleDateString('ru-RU', { month: 'short' })}</div>
                        </div>
                        <div style="font-size: 0.8rem; margin-bottom: 6px;">${dayTasks.length} ${getNoun(dayTasks.length, 'задача', 'задачи', 'задач')}</div>
                        <div class="category-summary-week">
                            ${Object.keys(categories).map(category => {
                                const categoryInfo = getCategoryInfo(category);
                                return `
                                    <div class="category-item-week">
                                        <div style="display: flex; align-items: center;">
                                            <div class="category-color-week" style="background-color: ${categoryInfo.color}"></div>
                                            <div class="category-name-week">${categoryInfo.name}</div>
                                        </div>
                                        <div class="category-count-week">${categories[category]}</div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    `;
                    
                    // При клике на день недели открываем задачи на этот день
                    dayCard.addEventListener('click', function(e) {
                        e.preventDefault();
                        showDayTasks(day);
                    });
                    
                    weekView.appendChild(dayCard);
                }
                
                contentArea.appendChild(weekView);
            }
            
            // Показать задачи на конкретный день
            function showDayTasks(date) {
                currentView = 'day';
                contentTitle.textContent = `Задачи на ${formatDate(date)}`;
                contentArea.innerHTML = '';
                
                const tasks = loadTasks();
                const dayTasks = tasks.filter(task => {
                    const taskDate = new Date(task.date).toDateString();
                    return taskDate === date.toDateString() && !task.deleted;
                });
                
                if (dayTasks.length === 0) {
                    contentArea.innerHTML = `<div class="empty-state"><p>Нет задач на ${formatDate(date)}</p></div>`;
                    return;
                }
                
                const taskList = document.createElement('div');
                taskList.className = 'notes-style-list';
                
                dayTasks.forEach(task => {
                    const taskElement = createEditableTaskElement(task);
                    taskList.appendChild(taskElement);
                });
                
                contentArea.appendChild(taskList);
                
                // Кнопка для добавления новой задачи на эту дату
                const addTaskBtn = document.createElement('button');
                addTaskBtn.className = 'btn btn-primary';
                addTaskBtn.textContent = 'Добавить задачу на эту дату';
                addTaskBtn.style.marginTop = '12px';
                
                addTaskBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    openAddTaskModalForDate(date);
                });
                
                contentArea.appendChild(addTaskBtn);
            }
            
            // Показать представление "Месяц"
            function showMonthView() {
                currentView = 'month';
                currentCategory = null;
                contentTitle.textContent = getMonthYearString(currentDate);
                closeCategoryViewBtn.style.display = 'none';
                contentArea.innerHTML = '';
                
                // Создание навигации по календарю
                const calendarHeader = document.createElement('div');
                calendarHeader.className = 'calendar-header';
                
                const monthDisplay = document.createElement('div');
                monthDisplay.className = 'calendar-month';
                monthDisplay.textContent = getMonthYearString(currentDate);
                
                const calendarNav = document.createElement('div');
                calendarNav.className = 'calendar-nav';
                calendarNav.innerHTML = `
                    <button id="prev-month"><i class="fas fa-chevron-left"></i></button>
                    <button id="today-month">Сегодня</button>
                    <button id="next-month"><i class="fas fa-chevron-right"></i></button>
                `;
                
                calendarHeader.appendChild(calendarNav);
                calendarHeader.appendChild(monthDisplay);
                
                // Создание календаря
                const calendar = document.createElement('div');
                calendar.className = 'calendar';
                
                const calendarGrid = document.createElement('div');
                calendarGrid.className = 'calendar-grid';
                
                // Заголовки дней недели
                const dayNames = ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'];
                dayNames.forEach(day => {
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day-name';
                    dayElement.textContent = day;
                    calendarGrid.appendChild(dayElement);
                });
                
                // Определение первого дня месяца
                const firstDay = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1);
                const lastDay = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0);
                const startDay = firstDay.getDay() === 0 ? 6 : firstDay.getDay() - 1;
                
                // Загрузка задач
                const tasks = loadTasks();
                
                // Заполнение пустых дней перед первым днем месяца
                for (let i = 0; i < startDay; i++) {
                    const emptyDay = document.createElement('div');
                    emptyDay.className = 'calendar-day empty';
                    calendarGrid.appendChild(emptyDay);
                }
                
                // Заполнение дней месяца
                for (let day = 1; day <= lastDay.getDate(); day++) {
                    const dayDate = new Date(currentDate.getFullYear(), currentDate.getMonth(), day);
                    const dayElement = document.createElement('div');
                    dayElement.className = 'calendar-day';
                    dayElement.dataset.date = dayDate.toISOString().split('T')[0];
                    
                    // Проверка, есть ли задачи на этот день
                    const dayTasks = tasks.filter(task => {
                        const taskDate = new Date(task.date).toDateString();
                        return taskDate === dayDate.toDateString() && !task.deleted;
                    });
                    
                    if (dayTasks.length > 0) {
                        dayElement.classList.add('has-tasks');
                    }
                    
                    // Определение, сегодня ли это
                    const today = new Date();
                    if (dayDate.toDateString() === today.toDateString()) {
                        dayElement.style.backgroundColor = 'rgba(74, 111, 165, 0.1)';
                    }
                    
                    dayElement.innerHTML = `
                        <div class="day-number">${day}</div>
                        <div class="day-tasks">
                            ${dayTasks.slice(0, 5).map(task => {
                                const categoryInfo = getCategoryInfo(task.category);
                                return `<div class="task-dot" style="background-color: ${categoryInfo.color}" title="${categoryInfo.name}"></div>`;
                            }).join('')}
                            ${dayTasks.length > 5 ? `<div style="font-size: 0.65rem; margin-left: 2px;">+${dayTasks.length - 5}</div>` : ''}
                        </div>
                    `;
                    
                    // Обработчик клика по дню
                    dayElement.addEventListener('click', function(e) {
                        e.preventDefault();
                        showDayTasks(dayDate);
                    });
                    
                    calendarGrid.appendChild(dayElement);
                }
                
                calendar.appendChild(calendarHeader);
                calendar.appendChild(calendarGrid);
                contentArea.appendChild(calendar);
                
                // Обработчики событий для навигации по месяцам
                document.getElementById('prev-month').addEventListener('click', function(e) {
                    e.preventDefault();
                    currentDate.setMonth(currentDate.getMonth() - 1);
                    showMonthView();
                });
                
                document.getElementById('next-month').addEventListener('click', function(e) {
                    e.preventDefault();
                    currentDate.setMonth(currentDate.getMonth() + 1);
                    showMonthView();
                });
                
                document.getElementById('today-month').addEventListener('click', function(e) {
                    e.preventDefault();
                    currentDate = new Date();
                    showMonthView();
                });
            }
            
            // Получить строку "Месяц Год"
            function getMonthYearString(date) {
                const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                                   'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
                return `${monthNames[date.getMonth()]} ${date.getFullYear()}`;
            }
            
            // Показать представление "Год"
            function showYearView() {
                currentView = 'year';
                currentCategory = null;
                contentTitle.textContent = `Год ${currentDate.getFullYear()}`;
                closeCategoryViewBtn.style.display = 'none';
                contentArea.innerHTML = '';
                
                const yearView = document.createElement('div');
                yearView.className = 'year-view';
                
                const tasks = loadTasks();
                const monthNames = ['Январь', 'Февраль', 'Март', 'Апрель', 'Май', 'Июнь', 
                                   'Июль', 'Август', 'Сентябрь', 'Октябрь', 'Ноябрь', 'Декабрь'];
                
                for (let month = 0; month < 12; month++) {
                    const monthCard = document.createElement('div');
                    monthCard.className = 'month-card-year';
                    
                    // Подсчет задач на месяц
                    const monthTasks = tasks.filter(task => {
                        const taskDate = new Date(task.date);
                        return taskDate.getFullYear() === currentDate.getFullYear() && 
                               taskDate.getMonth() === month && 
                               !task.deleted;
                    });
                    
                    const completedTasks = monthTasks.filter(task => task.completed).length;
                    
                    monthCard.innerHTML = `
                        <div class="month-name-year">${monthNames[month]}</div>
                        <div class="month-stats-year">
                            <div>Запланировано: ${monthTasks.length}</div>
                            <div>Выполнено: ${completedTasks}</div>
                        </div>
                    `;
                    
                    // Обработчик клика по месяцу
                    monthCard.addEventListener('click', function(e) {
                        e.preventDefault();
                        currentDate = new Date(currentDate.getFullYear(), month, 1);
                        showMonthView();
                    });
                    
                    yearView.appendChild(monthCard);
                }
                
                contentArea.appendChild(yearView);
            }
            
            // Открытие модального окна для добавления задачи на конкретную дату
            function openAddTaskModalForDate(date) {
                editingTaskId = null;
                document.getElementById('modal-title').textContent = 'Новая задача';
                document.getElementById('task-title').value = '';
                document.getElementById('task-description').value = '';
                document.getElementById('task-category').value = 'household';
                
                // Установка выбранной даты
                const formattedDate = date.toISOString().split('T')[0];
                document.getElementById('task-date').value = formattedDate;
                
                // Сброс повторяемости
                document.querySelector('.recurrence-option[data-value="none"]').click();
                
                taskModal.style.display = 'flex';
            }
            
            // Открытие модального окна для добавления задачи
            function openAddTaskModal() {
                openAddTaskModalForDate(new Date());
            }
            
            // Закрытие модального окна
            function closeTaskModal() {
                taskModal.style.display = 'none';
            }
            
            // Сохранение задачи
            function saveTask() {
                const title = document.getElementById('task-title').value.trim();
                const description = document.getElementById('task-description').value.trim();
                const category = document.getElementById('task-category').value;
                const date = document.getElementById('task-date').value;
                
                if (!title) {
                    alert('Введите название задачи');
                    return;
                }
                
                const tasks = loadTasks();
                
                const newTask = {
                    id: Date.now().toString(),
                    title,
                    description,
                    category,
                    date,
                    completed: false,
                    deleted: false,
                    createdAt: new Date().toISOString(),
                    recurrence: selectedRecurrence
                };
                
                // Установка параметров повторяемости
                if (selectedRecurrence === 'custom') {
                    newTask.recurrenceInterval = parseInt(document.getElementById('recurrence-interval').value);
                    newTask.recurrenceUnit = document.getElementById('recurrence-unit').value;
                }
                
                tasks.push(newTask);
                
                // Создание повторяющихся задач
                if (selectedRecurrence !== 'none') {
                    createRecurringTasks(newTask);
                }
                
                saveTasks(tasks);
                closeTaskModal();
                
                // Обновление отображения
                if (currentView === 'today') {
                    showTodayView();
                } else if (currentView === 'category') {
                    showCategoryView(currentCategory);
                } else if (currentView === 'month') {
                    showMonthView();
                } else if (currentView === 'day') {
                    const selectedDate = new Date(document.getElementById('task-date').value);
                    showDayTasks(selectedDate);
                }
            }
            
            // Создание повторяющихся задач
            function createRecurringTasks(task) {
                const tasks = loadTasks();
                const baseDate = new Date(task.date);
                
                // Количество повторений (например, на год вперед)
                const repetitions = 52;
                
                for (let i = 1; i <= repetitions; i++) {
                    const newDate = new Date(baseDate);
                    
                    if (task.recurrence === 'daily') {
                        newDate.setDate(baseDate.getDate() + i);
                    } else if (task.recurrence === 'weekly') {
                        newDate.setDate(baseDate.getDate() + (i * 7));
                    } else if (task.recurrence === 'monthly') {
                        newDate.setMonth(baseDate.getMonth() + i);
                    } else if (task.recurrence === 'custom') {
                        if (task.recurrenceUnit === 'days') {
                            newDate.setDate(baseDate.getDate() + (i * task.recurrenceInterval));
                        } else if (task.recurrenceUnit === 'weeks') {
                            newDate.setDate(baseDate.getDate() + (i * task.recurrenceInterval * 7));
                        } else if (task.recurrenceUnit === 'months') {
                            newDate.setMonth(baseDate.getMonth() + (i * task.recurrenceInterval));
                        }
                    }
                    
                    const recurringTask = {
                        ...task,
                        id: `${task.id}_${i}`,
                        date: newDate.toISOString(),
                        parentId: task.id
                    };
                    
                    // Проверяем, нет ли уже такой задачи
                    const existingTask = tasks.find(t => t.id === recurringTask.id);
                    if (!existingTask) {
                        tasks.push(recurringTask);
                    }
                }
                
                saveTasks(tasks);
            }
            
            // Проверка и перенос невыполненных задач на следующий день
            function checkAndMoveUncompletedTasks() {
                const tasks = loadTasks();
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                const yesterday = new Date(today);
                yesterday.setDate(yesterday.getDate() - 1);
                
                let updated = false;
                
                tasks.forEach(task => {
                    const taskDate = new Date(task.date);
                    taskDate.setHours(0, 0, 0, 0);
                    
                    // Если задача не выполнена, не удалена и ее дата вчерашняя
                    if (!task.completed && !task.deleted && taskDate.getTime() === yesterday.getTime()) {
                        // Переносим на сегодня
                        const newDate = new Date(today);
                        task.date = newDate.toISOString();
                        updated = true;
                    }
                });
                
                if (updated) {
                    saveTasks(tasks);
                    
                    // Обновление отображения, если нужно
                    if (currentView === 'today') {
                        showTodayView();
                    } else if (currentView === 'category') {
                        showCategoryView(currentCategory);
                    }
                }
            }
            
            // Экспорт данных (резервное копирование)
            function exportBackup() {
                const tasks = loadTasks();
                const backupData = {
                    version: '1.0',
                    exportDate: new Date().toISOString(),
                    tasks: tasks
                };
                
                const dataStr = JSON.stringify(backupData, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportFileDefaultName = `todo-planner-backup-${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportFileDefaultName);
                document.body.appendChild(linkElement);
                linkElement.click();
                document.body.removeChild(linkElement);
                
                alert('Резервная копия успешно сохранена!');
            }
            
            // Импорт данных (восстановление из резервной копии)
            function importBackup(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    try {
                        const backupData = JSON.parse(e.target.result);
                        
                        if (!backupData.tasks || !Array.isArray(backupData.tasks)) {
                            throw new Error('Некорректный формат файла');
                        }
                        
                        if (confirm('Вы уверены, что хотите восстановить данные из резервной копии? Текущие данные будут заменены.')) {
                            saveTasks(backupData.tasks);
                            alert('Данные успешно восстановлены!');
                            
                            // Обновление отображения
                            if (currentView === 'today') {
                                showTodayView();
                            } else if (currentView === 'category') {
                                showCategoryView(currentCategory);
                            } else if (currentView === 'month') {
                                showMonthView();
                            }
                        }
                    } catch (error) {
                        alert('Ошибка при восстановлении данных: ' + error.message);
                    }
                    
                    // Сброс значения input
                    importFileInput.value = '';
                };
                
                reader.readAsText(file);
            }
            
            // Запуск приложения
            initApp();
        });
    </script>
</body>
</html>
